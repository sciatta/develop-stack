# 缓存

## 数据分类和使用频率

数据分类

- 静态数据：一般不变，类似于字典表 

- 准静态数据：变化频率很低，部门结构设置，全国行政区划数据等 

- 中间状态数据：一些计算的可复用中间数据，变量副本，配置中心的本地副本 

这些数据适合于使用缓存的方式访问 

- 热数据：使用频率高
- 读写比较大：读的频率 >> 写的频率



## 缓存加载时机

- 启动全量加载

  全局有效，使用简单 

- 懒加载
  - 同步使用加载
    - 先看缓存是否有数据，没有的话从数据库读取 
    - 读取的数据，先放到内存，然后返回给调用方 
  - 延迟异步加载
    - 从缓存获取数据，不管是否为空直接返回
    - 如果为空，则发起一个异步加载的线程，负责加载数据 
    - 异步线程负责维护缓存的数据，定期或根据条件触发更新



## 缓存的有效性

- 读写比

  对数据的写操作导致数据变动，意味着维护成本。N : 1

- 命中率

  命中缓存意味着缓存数据被使用，意味着有价值。90%+



## 缓存使用不当导致的问题

- 系统预热导致启动慢

  试想一下，一个系统启动需要预热半个小时。 

  导致系统不能做到快速应对故障宕机等问题。 

- 系统内存资源耗尽 

  只加入数据，不能清理旧数据。

  旧数据处理不及时，或者不能有效识别无用数据。



## 缓存常见问题

- 缓存穿透

  大量并发查询不存在的key，导致直接将压力透传到数据库

  解决办法

  1. 缓存空值的key
  2. Bloom过滤或RoaringBitmap判断key是否存在
  3. 完全以缓存为准，使用延迟异步加载策略

- 缓存击穿

  某个key失效的时候，正好有大量并发请求访问这个key

  解决办法

  1. key的更新操作添加全局互斥锁
  2. 完全以缓存为准，使用延迟异步加载策略

- 缓存雪崩

  当某一时刻发生大规模缓存失效的情况，会有大量的请求直接打到数据库，导致数据库压力过大甚至宕机。

  解决办法

  1. 更新策略在时间上做到比较均匀
  2. 使用的热数据尽量分散到不同的机器上
  3. 多台机器做主从复制或多副本，实现高可用
  4. 实现熔断限流机制，对系统进行负载能力控制

